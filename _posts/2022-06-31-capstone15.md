---
title: "Capstone backend 15"
categories:
  -  Capstone
tags:
  -  JPA
  -  Spring
  -  Java
  -  Aws
  -  Cloud
---
개발일지 이번에 한것
------
memberRepositroy refactoring
http -> https 리다이렉트

일단 memberRepository refactoring부터 보겠다.
다음코드는 변경전이다.

```java
@Repository
@RequiredArgsConstructor
public class MemberRepository {
    private final EntityManager em;

    public Member save(Member member) {
        em.persist(member);
        return member;
    }
    public Member findOne(Long id) {
        return em.find(Member.class, id);
    }

    public Member findByEmail(String email){
        Member member;
        try {
            member = em.createQuery("select m from Member m where m.email=:email", Member.class)
                    .setParameter("email", email).getSingleResult();
        } catch(NoResultException e){
            return null;
        }
        return member;
    }
    public Member findPartyHost(Party party){
        PartyMember hostMember;
        try {
            hostMember = em.createQuery("select m from PartyMember m where m.party=:party and m.role=:role", PartyMember.class)
                    .setParameter("party", party)
                    .setParameter("role", Role.HOST)
                    .getSingleResult();
        } catch(NoResultException e){
            return null;
        }
        return hostMember.getMember();
    }

}
```

```java
@Repository
//@RequiredArgsConstructor
public interface MemberRepository extends JpaRepository<Member,Long> {
    Optional<Member> findByEmail(String email);
}
```
이게끝이다..

물론 Optional이 되서 부가적으로 다른것도 코드가 조금 바꾸긴 해야했다. 근데 이게 더 가독성이 좋고
코드수를 줄일수있어 좋다고 생각한다. 또 Optional을 사용하니 null처리로 편하다.

다른 세세한 부분은 다음 링크를 참고하길 바란다. [바뀐것들 링크](https://github.com/ran-3roads/Capstone-SportsMate/commit/7b5d598f9b4f0c077b8977d1b535323b1314de0e)

두번째로 한일 http -> https였다. 

구현 이유는 https설정을 했는데도 http로 접근이 가능하기 때문이다. 물론 어차피 api서버를 사용이 불가하기에 크게 의미는 없다. 그래도 http접근을 한다는것은 있을면 안돼는 일이라 생각한다.

그래서 이를 redirect 처리하기위한 작업을 하였다.

사실 이것의 해결방법은 엄청 간단하다.

그냥 nginx.conf에 

```conf
if ($http_x_forwarded_proto != 'https') {
            return 301 https://$host$request_uri;
         }
```
다음과같은 코드를 80포트 아래에 넣어두면 된다.

저말의 뜻은 https가 아닐때 https로 현 url을 redirect하라는것이다.
301은 표준 redirect 프로토콜이라고 한다.
[301 redirect](https://help.naver.com/support/contents/contents.help?serviceNo=14882&categoryNo=15447&from=alias)

이야 증말 간단하네요...

사실은 여기에 aws에 대한 비하인드 스토리가 있다. 이는 내일 이어서 풀겠다..